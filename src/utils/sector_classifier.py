"""
더 정교한 섹터 분류 시스템
WICS(World Industry Classification Standard) 기반 한국형 분류
"""

import logging
from typing import Dict, Optional

logger = logging.getLogger(__name__)

class SectorClassifier:
    def __init__(self):
        # 메가 섹터 분류
        self.mega_sectors = {
            'IT': ['IT/반도체', 'IT/소프트웨어', 'IT/하드웨어', 'IT/통신장비'],
            '헬스케어': ['바이오/제약', '의료기기', '헬스케어서비스'],
            '금융': ['은행', '증권', '보험', '기타금융'],
            '소재': ['화학', '철강', '비철금속', '종이/목재'],
            '산업재': ['조선', '기계', '건설', '항공/운송'],
            '에너지': ['석유/가스', '전력/유틸리티', '신재생에너지'],
            '필수소비재': ['식품', '생활용품', '소매유통'],
            '임의소비재': ['자동차', '엔터테인먼트', '섬유/의류'],
            '통신서비스': ['통신', 'IT/인터넷', '미디어'],
            '부동산': ['건설', 'REIT', '부동산서비스']
        }
        
        # 상세 섹터별 키워드 매핑 (대폭 확장)
        self.detailed_sectors = {
            # IT 섹터
            'IT/반도체': {
                'keywords': ['반도체', '시스템반도체', '메모리', '웨이퍼', '팹리스', '파운드리', 'DRAM', 'NAND', '플래시', 'SSD', 'CIS', '이미지센서'],
                'companies': ['삼성전자', 'SK하이닉스', 'LX세미콘', '실리콘웍스', 'DB하이텍', '네패스', '테스나', '원익IPS', 'WISCOM', '코아스템'],
                'name_patterns': ['반도체', '세미콘', '메모리', '웨이퍼', 'semi', 'memory']
            },
            'IT/소프트웨어': {
                'keywords': ['소프트웨어', '게임', '앱', '플랫폼', '클라우드', 'AI', '빅데이터', '인공지능', '머신러닝', 'ERP', 'CRM'],
                'companies': ['카카오', '네이버', 'NHN', '넥슨', 'NCSoft', '위메이드', '펄어비스', '크래프톤', '넷마블', '컴투스'],
                'name_patterns': ['게임', '소프트', '시스템', '테크놀로지', '솔루션', 'tech', 'soft', 'game']
            },
            'IT/하드웨어': {
                'keywords': ['하드웨어', '컴퓨터', 'PC', '서버', '스토리지', '임베디드', 'IoT', '센서'],
                'companies': ['삼성SDS', 'LG CNS', 'SK C&C'],
                'name_patterns': ['컴퓨터', '시스템', '하드웨어', '테크']
            },
            'IT/통신장비': {
                'keywords': ['통신장비', '네트워크', '5G', '기지국', '안테나', 'RF', '무선통신', 'WiFi', 'LTE'],
                'companies': ['KMW', '에이스테크놀로지', '우리기술', 'RF머티리얼즈'],
                'name_patterns': ['통신', '네트워크', '무선', 'RF', '안테나']
            },
            
            # 헬스케어 (대폭 확장)
            '바이오/제약': {
                'keywords': ['바이오', '제약', '의약품', '백신', '항체', '신약', '임상', '치료제', '진단', '의료', '헬스케어'],
                'companies': ['셀트리온', '삼성바이오로직스', '유한양행', '한미약품', '대웅제약', '녹십자', '신풍제약', 'JW중외제약', '일양약품'],
                'name_patterns': ['바이오', '제약', '메디', '파마', '헬스', 'bio', 'pharm', 'med']
            },
            '의료기기': {
                'keywords': ['의료기기', '진단기기', 'MRI', 'CT', '초음파', '엑스레이', '혈액분석', '체외진단'],
                'companies': ['메디톡스', 'HLB', '씨젠', '랩지노믹스', 'PCL'],
                'name_patterns': ['메디', '진단', '의료기기', 'medical']
            },
            
            # 금융 (세분화)
            '은행': {
                'keywords': ['은행', '금융지주', '저축은행'],
                'companies': ['KB금융', '신한지주', '하나금융지주', '우리금융지주', 'BNK금융지주', 'JB금융지주', '제주은행'],
                'name_patterns': ['은행', '금융', 'bank', '저축']
            },
            '증권': {
                'keywords': ['증권', '투자', '자산운용', 'IB', '투자은행'],
                'companies': ['미래에셋증권', '삼성증권', 'NH투자증권', 'KB증권', '한국투자증권'],
                'name_patterns': ['증권', '투자', '자산운용', 'securities']
            },
            '보험': {
                'keywords': ['보험', '생명보험', '손해보험', '재보험'],
                'companies': ['삼성생명', '한화생명', 'DB손해보험', '현대해상', 'KB손해보험'],
                'name_patterns': ['보험', '생명', '손해', 'insurance']
            },
            '핀테크': {
                'keywords': ['핀테크', '결제', '페이', 'pay', '금융기술', '블록체인', '암호화폐'],
                'companies': ['카카오페이', '토스', 'NICE페이먼츠', 'KG이니시스'],
                'name_patterns': ['페이', 'pay', '결제', '핀테크']
            },
            
            # 소재 (확장)
            '화학': {
                'keywords': ['화학', '정유', '석유화학', '플라스틱', '합성수지', '정밀화학', '촉매', '첨가제'],
                'companies': ['LG화학', 'SK이노베이션', '한화솔루션', 'S-Oil', 'GS칼텍스', '롯데케미칼', 'OCI'],
                'name_patterns': ['화학', '케미칼', '정유', '플라스틱', 'chemical', 'oil']
            },
            '철강': {
                'keywords': ['철강', '제철', '특수강', '강관', '스테인리스', '압연'],
                'companies': ['포스코', '현대제철', '동국제강', 'SeAH베스틸', '대한제강'],
                'name_patterns': ['철강', '제철', '스틸', 'steel', '강관']
            },
            '비철금속': {
                'keywords': ['알루미늄', '구리', '아연', '니켈', '희토류', '동', '납', '주석'],
                'companies': ['삼아알미늄', '풍산', 'KG동부제철', '영풍'],
                'name_patterns': ['알미늄', '구리', '아연', '동', '금속', 'metal']
            },
            
            # 산업재 (확장)
            '조선': {
                'keywords': ['조선', '중공업', '해양플랜트', '선박', '해양구조물', '드릴십'],
                'companies': ['HD현대중공업', 'HD현대', '대우조선해양', '삼성중공업', 'HJ중공업', 'STX조선해양'],
                'name_patterns': ['조선', '중공업', '해양', '마린', '선박', 'marine', 'ship']
            },
            '기계': {
                'keywords': ['기계', '중장비', '산업기계', '로봇', '자동화', '공작기계', '건설장비'],
                'companies': ['두산에너빌리티', '현대위아', '만도', '두산밥캣', 'LS머트리얼즈'],
                'name_patterns': ['기계', '로봇', '자동화', '엔지니어링', '산업']
            },
            '건설': {
                'keywords': ['건설', '건축', '토목', '인프라', '플랜트', '엔지니어링'],
                'companies': ['삼성물산', '현대건설', '대림건설', 'GS건설', '대우건설', '포스코건설'],
                'name_patterns': ['건설', '건축', '토목', '플랜트', 'construction']
            },
            '항공/운송': {
                'keywords': ['항공', '운송', '물류', '택배', '해운', '선박운항', '화물'],
                'companies': ['대한항공', '아시아나항공', 'CJ대한통운', '팬오션', 'HMM', '롯데글로벌로지스'],
                'name_patterns': ['항공', '운송', '물류', '택배', '해운', 'air', 'logistics']
            },
            
            # 에너지 (확장)
            '전력/유틸리티': {
                'keywords': ['전력', '발전', '유틸리티', '가스', '상하수도', '폐기물처리'],
                'companies': ['한국전력', 'SK가스', '한국가스공사', 'GS', '한국지역난방공사'],
                'name_patterns': ['전력', '발전', '가스', '에너지', 'energy', 'power']
            },
            '신재생에너지': {
                'keywords': ['태양광', '풍력', '수소', '연료전지', '배터리', 'ESS', '원자력'],
                'companies': ['한화솔루션', 'SK아이이테크놀로지', '한국수력원자력'],
                'name_patterns': ['태양광', '풍력', '수소', '연료전지', 'solar', 'wind']
            },
            
            # 필수소비재 (확장)
            '식품': {
                'keywords': ['식품', '음료', '제과', '유제품', '주류', '커피', '라면', '과자'],
                'companies': ['농심', '오리온', '롯데제과', '동원F&B', '매일유업', '남양유업', '하이트진로'],
                'name_patterns': ['식품', '푸드', '음료', '제과', '유업', 'food', 'beverage']
            },
            '생활용품': {
                'keywords': ['생활용품', '화장품', '세제', '위생용품', '퍼스널케어'],
                'companies': ['아모레퍼시픽', 'LG생활건강', '유니레버코리아', '코스맥스'],
                'name_patterns': ['화장품', '생활용품', '퍼스널', 'cosmetic']
            },
            '소매유통': {
                'keywords': ['백화점', '마트', '편의점', '온라인쇼핑', '리테일'],
                'companies': ['롯데쇼핑', '신세계', '현대백화점', 'GS리테일', '이마트'],
                'name_patterns': ['쇼핑', '백화점', '마트', '리테일', 'retail']
            },
            
            # 임의소비재 (확장)
            '자동차': {
                'keywords': ['자동차', '완성차', '자동차부품', '타이어', '자율주행'],
                'companies': ['현대차', '기아', '현대모비스', '만도', '한온시스템', '넥센타이어'],
                'name_patterns': ['자동차', '모터스', '모비스', '타이어', 'motor', 'auto']
            },
            'TV/영화/음악': {
                'keywords': ['엔터테인먼트', '방송', '영화', '음악', 'K-POP', 'OTT', '콘텐츠'],
                'companies': ['CJ ENM', 'HYBE', 'YG엔터테인먼트', 'SM엔터테인먼트', 'JYP엔터테인먼트'],
                'name_patterns': ['엔터', '미디어', '방송', '콘텐츠', 'entertainment']
            },
            '섬유/의류': {
                'keywords': ['섬유', '의류', '패션', '스포츠의류', '원단'],
                'companies': ['한세실업', '영원무역', '삼양사', 'LF'],
                'name_patterns': ['섬유', '의류', '패션', 'fashion', 'textile']
            },
            
            # 통신서비스 (확장)
            '통신': {
                'keywords': ['통신', '이동통신', '유선통신', '케이블TV', '인터넷서비스'],
                'companies': ['KT', 'SK텔레콤', 'LG유플러스', 'SKB', 'LG헬로비전'],
                'name_patterns': ['텔레콤', '통신', 'telecom', '유플러스']
            },
            'IT/인터넷': {
                'keywords': ['인터넷', '포털', '전자상거래', '핀테크', '플랫폼', 'e-커머스'],
                'companies': ['네이버', '카카오', '쿠팡', '카카오페이', '11번가', '티몬'],
                'name_patterns': ['인터넷', '포털', '커머스', 'internet', 'commerce']
            },
            
            # 기타 (대폭 확장)
            '전기/전자부품': {
                'keywords': ['전자부품', '디스플레이', 'LED', '반도체장비', 'OLED', 'LCD', '터치패널'],
                'companies': ['LG디스플레이', '삼성디스플레이', '서울반도체', 'BOE하이디스', '동진쎄미켐'],
                'name_patterns': ['디스플레이', '전자', 'LED', 'LCD', 'OLED', 'display']
            },
            '2차전지': {
                'keywords': ['배터리', '2차전지', '양극재', '음극재', '전해액', '분리막', 'ESS'],
                'companies': ['LG에너지솔루션', '삼성SDI', 'SK온', '포스코케미칼', '에코프로', '에코프로비엠'],
                'name_patterns': ['배터리', '전지', '양극재', '음극재', 'battery']
            },
            '우주/항공': {
                'keywords': ['우주', '항공우주', '위성', '발사체', '드론', '항공기부품'],
                'companies': ['한국항공우주산업', '쎄트렉아이', '에스피지'],
                'name_patterns': ['우주', '항공우주', '위성', '에어로스페이스']
            },
            '국방': {
                'keywords': ['방산', '국방', '무기', '방위산업', '군수'],
                'companies': ['한화시스템', '한화에어로스페이스', 'LIG넥스원'],
                'name_patterns': ['방산', '국방', '군수', 'defense']
            }
        }
    
    def classify_sector(self, ticker: str, company_name: str) -> str:
        """
        종목 코드와 회사명을 기반으로 고도화된 섹터 분류
        """
        try:
            # 1. 특정 대형주 직접 매핑 (대폭 확장)
            large_cap_mapping = {
                # IT 대형주
                '005930': 'IT/반도체',       # 삼성전자
                '000660': 'IT/반도체',       # SK하이닉스
                '035420': 'IT/인터넷',       # NAVER
                '035720': 'IT/인터넷',       # 카카오
                '036570': 'IT/인터넷',       # 엔씨소프트
                '112040': 'IT/소프트웨어',   # 위메이드
                '251270': 'IT/인터넷',       # 넷마블
                '108320': 'IT/반도체',       # LX세미콘
                '042700': 'IT/반도체',       # 한미반도체
                '377300': 'IT/인터넷',       # 카카오페이
                
                # 화학/소재
                '051910': '화학',            # LG화학
                '010950': '화학',            # S-Oil
                '011170': '화학',            # 롯데케미칼
                '004020': '화학',            # 현대제철
                '005490': '철강',            # POSCO홀딩스
                '006110': '비철금속',        # 삼아알미늄
                
                # 2차전지/배터리
                '006400': '2차전지',         # 삼성SDI
                '373220': '2차전지',         # LG에너지솔루션
                '096770': '2차전지',         # SK이노베이션
                '086520': '2차전지',         # 에코프로
                '247540': '2차전지',         # 에코프로비엠
                
                # 바이오/제약
                '207940': '바이오/제약',     # 삼성바이오로직스
                '068270': '바이오/제약',     # 셀트리온
                '000100': '바이오/제약',     # 유한양행
                '128940': '바이오/제약',     # 한미약품
                '069620': '바이오/제약',     # 대웅제약
                '302440': '바이오/제약',     # 셀트리온제약
                
                # 조선/중공업
                '329180': '조선',            # HD현대중공업
                '009540': '조선',            # HD한국조선해양
                '042660': '조선',            # 대우조선해양
                '010140': '조선',            # 삼성중공업
                '267250': '조선',            # HD현대
                
                # 자동차
                '005380': '자동차',          # 현대차
                '000270': '자동차',          # 기아
                '012330': '자동차',          # 현대모비스
                '204320': '자동차',          # 만도
                '021240': '자동차',          # 코웨이
                
                # 금융
                '105560': '은행',            # KB금융
                '055550': '은행',            # 신한지주
                '086790': '은행',            # 하나금융지주
                '316140': '은행',            # 우리금융지주
                '175330': '은행',            # JB금융지주
                '006220': '은행',            # 제주은행
                
                # 통신
                '034730': '통신',            # SK텔레콤
                '030200': '통신',            # KT
                '032640': '통신',            # LG유플러스
                
                # 건설
                '028260': '건설',            # 삼성물산
                '000720': '건설',            # 현대건설
                '006360': '건설',            # GS건설
                '047040': '건설',            # 대우건설
                
                # 디스플레이/전자부품
                '034220': '전기/전자부품',   # LG디스플레이
                '009150': '전기/전자부품',   # 삼성전기
                '042670': '전기/전자부품',   # HD현대인프라코어
                
                # 기타 주요 종목들
                '000810': '보험',            # 삼성화재
                '018260': 'IT/하드웨어',     # 삼성SDS
                '090430': '2차전지',         # 아모레퍼시픽
                '161390': '항공/운송',       # 한국항공우주산업
            }
            
            if ticker in large_cap_mapping:
                return large_cap_mapping[ticker]
            
            # 2. 회사명을 정규화 (특수문자, 공백 제거)
            company_clean = company_name.replace('(주)', '').replace('㈜', '').strip()
            company_lower = company_clean.lower()
            
            # 3. name_patterns 기반 정밀 매칭 (우선순위 높음)
            for sector, info in self.detailed_sectors.items():
                if 'name_patterns' in info:
                    for pattern in info['name_patterns']:
                        if pattern.lower() in company_lower:
                            return sector
            
            # 4. 회사명 기반 키워드 매칭 (더 정교한 매칭)
            for sector, info in self.detailed_sectors.items():
                # 정확한 회사명 매칭 (우선순위 높음)
                for company in info['companies']:
                    if company in company_clean:
                        return sector
                
                # 키워드 매칭 (부분 매칭)
                for keyword in info['keywords']:
                    if len(keyword) >= 3 and keyword.lower() in company_lower:
                        return sector
            
            # 5. 고도화된 패턴 매칭
            advanced_patterns = {
                'IT/반도체': ['반도체', 'semi', '세미콘', '메모리', 'memory', '칩', 'chip'],
                'IT/소프트웨어': ['게임', 'game', '소프트', 'soft', '시스템', '솔루션', 'tech'],
                'IT/인터넷': ['인터넷', 'internet', '포털', '커머스', 'commerce', '페이', 'pay'],
                '바이오/제약': ['바이오', 'bio', '제약', 'pharm', '메디', 'med', '헬스', 'health'],
                '화학': ['화학', 'chemical', '케미칼', '정유', 'oil', '플라스틱'],
                '2차전지': ['배터리', 'battery', '전지', '양극재', '음극재'],
                '조선': ['조선', '중공업', '해양', 'marine', '선박', 'ship'],
                '자동차': ['자동차', '모터스', 'motor', '모비스', '타이어'],
                '건설': ['건설', 'construction', '건축', '토목', '플랜트'],
                '금융': ['금융', '은행', 'bank', '증권', '보험', 'insurance'],
                '항공/운송': ['항공', 'air', '운송', '물류', 'logistics', '택배'],
                '전기/전자부품': ['디스플레이', 'display', 'LED', 'LCD', 'OLED'],
            }
            
            for sector, patterns in advanced_patterns.items():
                for pattern in patterns:
                    if pattern.lower() in company_lower:
                        return sector
            
            # 6. 추가 특수 케이스 매칭
            special_cases = {
                'HD': '조선',
                '현대': '자동차',
                'LG': 'IT/반도체',
                'SK': 'IT/반도체',
                '삼성': 'IT/반도체',
                'KT': '통신',
                '셀트리온': '바이오/제약',
                'POSCO': '철강',
                '포스코': '철강',
            }
            
            for keyword, sector in special_cases.items():
                if keyword in company_clean:
                    return sector
            
            # 7. 기본값
            return '기타'
            
        except Exception as e:
            logger.warning(f"섹터 분류 실패 ({ticker}, {company_name}): {e}")
            return '기타'
    
    def get_mega_sector(self, detailed_sector: str) -> str:
        """상세 섹터에서 메가 섹터 반환"""
        for mega, details in self.mega_sectors.items():
            if detailed_sector in details:
                return mega
        return '기타'
    
    def get_sector_description(self, sector: str) -> str:
        """섹터 설명 반환"""
        descriptions = {
            'IT/반도체': '메모리/시스템반도체 제조',
            'IT/소프트웨어': '소프트웨어/게임/플랫폼',
            'IT/인터넷': '인터넷/플랫폼/핀테크',
            '바이오/제약': '바이오의약품/제약',
            '화학': '석유화학/정밀화학',
            '조선': '조선/해양플랜트',
            '자동차': '완성차/부품',
            '2차전지': '배터리/에너지저장',
            '전기/전자부품': '디스플레이/전자부품',
            '은행': '은행/금융지주',
            '건설': '건설/토목',
            '통신': '이동통신/유선통신'
        }
        return descriptions.get(sector, sector)